version: '3.8'

services:
  db:
    container_name: seafile_mysql
    image: mariadb:10.11
    environment:
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/seafile_mysql_root_password
      MYSQL_LOG_CONSOLE: 'true'
      MARIADB_AUTO_UPGRADE: 1
    volumes:
      - seafile-db:/var/lib/mysql
    secrets:
      - seafile_mysql_root_password
    healthcheck:
      test: healthcheck.sh --connect --mariadbupgrade --innodb_initialized
      start_period: 10s
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      restart_policy:
        condition: on-failure

  redis:
    container_name: seafile_redis
    image: redis:7
    healthcheck:
      test: redis-cli ping || exit 1
    deploy:
      restart_policy:
        condition: on-failure

  collabora:
    container_name: seafile_collabora
    image: collabora/code:24.04.5.1.1
    cap_add:
      - SYS_CHROOT
      - SYS_ADMIN
    security_opt:
      - seccomp:unconfined
    environment:
      aliasgroup1: https://${SEAFILE_SERVER_HOSTNAME}:443
      server_name: ${COLLABORA_SERVER_HOSTNAME}
      dictionaries: de_DE en_GB en_US
      extra_params: --o:ssl.enable=false --o:ssl.termination=true
      TZ: Europe/Berlin
    ports:
      - ${COLLABORA_PORT}:9980
    healthcheck:
      test: curl -f http://localhost:9980/hosting/discovery || exit 1
      start_period: 30s
      interval: 15s
      timeout: 10s
      retries: 5
    deploy:
      restart_policy:
        condition: on-failure

  onlyoffice:
    container_name: seafile_onlyoffice
    image: onlyoffice/documentserver:8.1.0.1
    environment:
      JWT_ENABLED: 'true'
    ports:
      - ${ONLYOFFICE_PORT}:80
    volumes:
      - seafile-onlyoffice-data:/var/www/onlyoffice/Data
      - seafile-onlyoffice-lib:/var/lib/onlyoffice
      - seafile-onlyoffice-log:/var/log/onlyoffice
    entrypoint:
      - /bin/bash
      - -c
      - |
        export JWT_SECRET=$$(cat /run/secrets/onlyoffice_jwt_secret)
        exec /app/ds/run-document-server.sh
    secrets:
      - onlyoffice_jwt_secret
    healthcheck:
      test: curl -f http://localhost/healthcheck || exit 1
      start_period: 60s
      interval: 15s
      timeout: 10s
      retries: 5
    deploy:
      restart_policy:
        condition: on-failure

  seafile:
    container_name: seafile
    image: seafileltd/seafile-mc:13.0-latest
    ports:
      - ${HTTP_PORT}:80
    volumes:
      - seafile-data:/shared
    environment:
      SEAFILE_MYSQL_DB_HOST: db
      SEAFILE_MYSQL_DB_PORT: 3306
      SEAFILE_MYSQL_DB_USER: ${SEAFILE_DB_USER}
      SEAFILE_MYSQL_DB_CCNET_DB_NAME: ccnet_db
      SEAFILE_MYSQL_DB_SEAFILE_DB_NAME: seafile_db
      SEAFILE_MYSQL_DB_SEAHUB_DB_NAME: seahub_db
      SEAFILE_SERVER_HOSTNAME: ${SEAFILE_SERVER_HOSTNAME}
      SEAFILE_SERVER_PROTOCOL: ${SEAFILE_SERVER_PROTOCOL}
      INIT_SEAFILE_ADMIN_EMAIL: ${SEAFILE_ADMIN_EMAIL}
      TIME_ZONE: Europe/Berlin
      NON_ROOT: 'false'
      ENABLE_SEADOC: 'false'
      ENABLE_GO_FILESERVER: 'true'
      CACHE_PROVIDER: redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ''
    command:
      - /bin/bash
      - -c
      - |
        export SEAFILE_MYSQL_DB_PASSWORD=$$(cat /run/secrets/seafile_db_password)
        export INIT_SEAFILE_MYSQL_ROOT_PASSWORD=$$(cat /run/secrets/seafile_mysql_root_password)
        export INIT_SEAFILE_ADMIN_PASSWORD=$$(cat /run/secrets/seafile_admin_password)
        export JWT_PRIVATE_KEY=$$(cat /run/secrets/seafile_jwt_private_key)
        exec /sbin/my_init -- /scripts/enterpoint.sh
    depends_on:
      - db
      - redis
      - collabora
      - onlyoffice
    secrets:
      - seafile_mysql_root_password
      - seafile_db_password
      - seafile_admin_password
      - seafile_jwt_private_key
    healthcheck:
      test: curl -f http://localhost:80 || exit 1
      start_period: 30s
      interval: 15s
      timeout: 10s
      retries: 5
    deploy:
      restart_policy:
        condition: on-failure

  seafile-md-server:
    container_name: seafile_md_server
    image: seafileltd/seafile-md-server:13.0-latest
    volumes:
      - seafile-data:/shared
    environment:
      SEAFILE_MYSQL_DB_HOST: db
      SEAFILE_MYSQL_DB_PORT: 3306
      SEAFILE_MYSQL_DB_USER: ${SEAFILE_DB_USER}
      SEAFILE_MYSQL_DB_SEAFILE_DB_NAME: seafile_db
      SEAFILE_LOG_TO_STDOUT: 'true'
      MD_PORT: 8084
      MD_LOG_LEVEL: info
      MD_MAX_CACHE_SIZE: ${MD_MAX_CACHE_SIZE}
      MD_CHECK_UPDATE_INTERVAL: 30m
      MD_FILE_COUNT_LIMIT: 100000
      MD_STORAGE_TYPE: disk
      CACHE_PROVIDER: redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ''
    command:
      - /bin/bash
      - -c
      - |
        export JWT_PRIVATE_KEY=$$(cat /run/secrets/seafile_jwt_private_key)
        export SEAFILE_MYSQL_DB_PASSWORD=$$(cat /run/secrets/seafile_db_password)
        exec /opt/scripts/entrypoint.sh
    secrets:
      - seafile_jwt_private_key
      - seafile_db_password
    depends_on:
      - db
      - redis
      - seafile
    healthcheck:
      test: grep -q ':1F94' /proc/net/tcp || grep -q ':1F94' /proc/net/tcp6 || exit 1
      start_period: 120s
      interval: 15s
      timeout: 10s
      retries: 5
    deploy:
      restart_policy:
        condition: on-failure

volumes:
  seafile-data:
    external: true
    name: ${VOLUME_NAME_DATA}
  seafile-db:
    external: true
    name: ${VOLUME_NAME_DB}
  seafile-onlyoffice-data:
    external: true
    name: ${VOLUME_NAME_ONLYOFFICE_DATA}
  seafile-onlyoffice-lib:
    external: true
    name: ${VOLUME_NAME_ONLYOFFICE_LIB}
  seafile-onlyoffice-log:
    external: true
    name: ${VOLUME_NAME_ONLYOFFICE_LOG}

secrets:
  seafile_mysql_root_password:
    external: true
  seafile_db_password:
    external: true
  seafile_admin_password:
    external: true
  seafile_jwt_private_key:
    external: true
  onlyoffice_jwt_secret:
    external: true
